version: '3.7'
services:
 mysql:
  container_name: ${NAME}_mysql
  image: mysql:8.0.13
  restart: on-failure
  command: ["--default-authentication-plugin=mysql_native_password"]
  volumes:
   - "./.data/mysql:/var/lib/mysql"
  environment:
   MYSQL_DATABASE: ${MYSQL_DATABASE}
   MYSQL_USER: ${MYSQL_DATABASE_USER}
   MYSQL_PASSWORD: ${MYSQL_PASSWORD}
   MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
  networks:
   default:
    ipv4_address: ${MYSQL_IP}
 php:
  container_name: ${NAME}_php
  build:
   context: ./etc/php
  volumes:
   - "./project/:/srv/src/project:cached"
   - "./etc/php/config/xdebug.ini:/usr/local/etc/php/conf.d/xdebug.ini"
  networks:
   default:
    ipv4_address: ${PHP_IP}
 nginx:
  container_name: ${NAME}_nginx
  image: nginx:1.15.8
  volumes:
   - "./.data/nginx/logs:/var/log/nginx"
   - "./etc/nginx/project.conf:/etc/nginx/conf.d/default.conf"
   - "./project/:/srv/src/project:cached"
  networks:
   default:
    ipv4_address: ${NGINX_IP}
 elasticsearch:
  image: docker.elastic.co/elasticsearch/elasticsearch:7.5.1
  user: 1000:1000
  container_name: ${NAME}_elasticsearch
  restart: unless-stopped
  ports:
   - ${ELASTIC_PORT}:9200
  environment:
   - discovery.type=single-node
   - xpack.security.enabled=true
   - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
   - ELASTIC_USERNAME=${ELASTIC_USERNAME}
   - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
  volumes:
   - ./.data/elasticsearch:/usr/share/elasticsearch/data
  networks:
   default:
    ipv4_address: ${ELASTIC_IP}
 kibana:
  image: docker.elastic.co/kibana/kibana:7.5.1
  container_name: ${NAME}_kibana
  ports:
   - ${KIBANA_PORT}:5601
  networks:
   default:
    ipv4_address: ${KIBANA_IP}
  depends_on:
   - elasticsearch
  environment:
   ELASTICSEARCH_HOSTS: http://${ELASTIC_IP}:${ELASTIC_PORT}
   ELASTICSEARCH_USERNAME: ${ELASTIC_USERNAME}
   ELASTICSEARCH_PASSWORD: ${ELASTIC_PASSWORD}
   XPACK_SECURITY_ENABLED: "true"
networks:
 default:
  driver: bridge
  ipam:
   driver: default
   config:
    - subnet: ${SUBNET}

